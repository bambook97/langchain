# PG-Vector-Indexer

Система семантического поиска по кодовой базе с использованием PostgreSQL, расширения pgvector и Ollama для создания эмбеддингов.

## Описание

PG-Vector-Indexer - это инструмент для создания системы RAG (Retrieval-Augmented Generation) для кодовой базы. Он позволяет:

1. Индексировать исходный код из указанных директорий
2. Хранить векторные представления (эмбеддинги) кода в PostgreSQL с использованием расширения pgvector
3. Выполнять семантический поиск по проиндексированному коду

Система особенно полезна для:
- Быстрого поиска релевантных частей кода в больших проектах
- Семантического поиска, основанного на смысле, а не на точном совпадении текста
- Создания RAG-систем для работы с кодовыми базами

## Требования

- Node.js (v18+)
- TypeScript
- Docker и Docker Compose
- [Ollama](https://ollama.ai/) для генерации эмбеддингов
- PostgreSQL с расширением pgvector (устанавливается через Docker)

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone <url-репозитория>
cd pg-vector-indexer
```

### 2. Установка зависимостей

```bash
npm install
```

### 3. Настройка окружения

Создайте файл `.env` на основе примера `.env.example`:

```bash
cp .env.example .env
```

Затем отредактируйте `.env`, указав необходимые параметры:

```

DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=langchain

# Названия таблиц
VECTOR_TABLE=code_vectors
RECORD_TABLE=code_records
```

### 4. Установка и запуск Ollama

1. Скачайте и установите Ollama с [официального сайта](https://ollama.ai/)
2. Загрузите модель `nomic-embed-text` для генерации эмбеддингов:

```bash
ollama pull nomic-embed-text
```

3. Убедитесь, что сервис Ollama запущен:

```bash
ollama serve
```

### 5. Запуск PostgreSQL с pgvector

Используйте Docker Compose для запуска PostgreSQL с предустановленным расширением pgvector:

```bash
docker-compose up -d
```

### 6. Создание схемы базы данных

```bash
npm run recreate-schema
```

## Использование

### Индексация кода

Для индексации директории с кодом используйте:

```bash
npm run dev -- <путь-к-директории> [namespace]
```

Где:
- `<путь-к-директории>` - путь к директории с исходным кодом для индексации
- `[namespace]` - опциональный namespace для группировки индексов (по умолчанию "code_index")

Пример:

```bash
npm run dev -- ./src my-project
```

### Поиск по индексированному коду

Для выполнения семантического поиска по проиндексированному коду:

```bash
npm run search -- "ваш поисковый запрос" [количество-результатов]
```

Где:
- `"ваш поисковый запрос"` - текстовый запрос для поиска
- `[количество-результатов]` - опциональное количество результатов для вывода (по умолчанию 3)

Пример:

```bash
npm run search -- "функция для подключения к базе данных" 5
```

## Поддерживаемые форматы файлов

Система поддерживает индексацию следующих типов файлов:
- `.ts`, `.js` - JavaScript и TypeScript
- `.tsx`, `.jsx` - React компоненты
- `.md` - Markdown документация
- `.map` - Source Map файлы

## Структура проекта

- `src/index.ts` - основной скрипт индексации
- `src/retrieval.ts` - скрипт для поиска по индексированным данным
- `src/recreate-schema.ts` - скрипт для создания/пересоздания схемы базы данных
- `docker-compose.yml` - конфигурация Docker для PostgreSQL с pgvector
- `.env.example` - пример конфигурации окружения

## Детали реализации

- Система использует LangChain для работы с документами и их разделения на чанки
- Для хранения эмбеддингов используется PostgreSQL с расширением pgvector
- Индексирование происходит в следующие этапы:
    1. Загрузка документов из директории
    2. Разбивка документов на чанки для лучшей точности поиска
    3. Создание эмбеддингов с помощью Ollama (модель nomic-embed-text)
    4. Сохранение эмбеддингов в PostgreSQL
    5. Ведение записей в таблице code_records для отслеживания уже проиндексированных документов



### Добавление поддержки других форматов файлов

Для добавления поддержки других типов файлов, отредактируйте объект конфигурации в функции `indexDirectory` в файле `src/index.ts`:

```typescript
const loader = new DirectoryLoader(dirPath, {
    ".ts": (filePath) => new TextLoader(filePath),
    ".js": (filePath) => new TextLoader(filePath),
    // Добавьте новые форматы:
    ".py": (filePath) => new TextLoader(filePath),
    ".java": (filePath) => new TextLoader(filePath),
});
```

## Устранение неполадок

### Проблемы с подключением к PostgreSQL

Убедитесь, что:
1. Docker контейнер с PostgreSQL запущен: `docker ps`
2. PostgreSQL доступен по порту 5432: `nc -zv localhost 5432`
3. Параметры подключения в файле `.env` корректны

### Проблемы с Ollama

Проверьте:
1. Ollama запущен: `ps aux | grep ollama`
2. Модель nomic-embed-text загружена: `ollama list`
3. Ollama доступен по адресу http://localhost:11434

## Лицензия

[MIT](LICENSE)